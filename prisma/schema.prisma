generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Profile {
  id                String   @id @db.Uuid
  username          String?  @unique
  displayName       String?  @map("display_name")
  avatarUrl         String?  @map("avatar_url")
  bannerUrl         String?  @map("banner_url")
  totalExp          Int      @default(0) @map("total_exp")
  level             Int      @default(1)
  bio               String?
  favoriteAnimeId   String?  @map("favorite_anime_id") @db.Uuid
  favoriteMangaId   String?  @map("favorite_manga_id") @db.Uuid
  location          String?
  website           String?
  socialLinks       Json?    @default("{}") @map("social_links")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  favoriteAnime     AnimeEntry?  @relation("FavoriteAnime", fields: [favoriteAnimeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  favoriteManga     MangaEntry?  @relation("FavoriteManga", fields: [favoriteMangaId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  userModules       UserModule[]
  workouts          Workout[]
  mangaCollection   MangaEntry[]
  animeList         AnimeEntry[]
  quests            Quest[]
  questCompletions  QuestCompletion[]
  questNotifications QuestNotification[]
  partiesOwned      Party[]        @relation("PartyOwner")
  partyMembers      PartyMember[]
  releaseCalendar   ReleaseCalendar[]

  @@map("profiles")
}

model UserModule {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  moduleId  String   @map("module_id")
  enabled   Boolean  @default(true)
  enabledAt DateTime @default(now()) @map("enabled_at") @db.Timestamptz(6)

  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleId])
  @@map("user_modules")
}

model Workout {
  id             String            @id @default(uuid()) @db.Uuid
  userId         String            @map("user_id") @db.Uuid
  name           String
  description    String?
  workoutDate    DateTime          @map("workout_date") @db.Date
  durationMinutes Int?             @map("duration_minutes")
  notes          String?
  status         String            @default("completed")
  startedAt      DateTime?         @map("started_at") @db.Timestamptz(6)
  completedAt   DateTime?         @map("completed_at") @db.Timestamptz(6)
  createdAt      DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user           Profile           @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercises      WorkoutExercise[]

  @@index([userId, workoutDate(sort: Desc)])
  @@index([userId, status])
  @@map("workouts")
}

model WorkoutExercise {
  id         String       @id @default(uuid()) @db.Uuid
  workoutId  String       @map("workout_id") @db.Uuid
  exerciseName String    @map("exercise_name")
  notes      String?
  orderIndex Int          @default(0) @map("order_index")
  createdAt  DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)

  workout    Workout      @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  sets       WorkoutSet[]

  @@index([workoutId])
  @@map("workout_exercises")
}

model WorkoutSet {
  id          String          @id @default(uuid()) @db.Uuid
  exerciseId  String          @map("exercise_id") @db.Uuid
  setNumber   Int             @map("set_number")
  reps        Int?
  weightKg    Decimal?        @map("weight_kg") @db.Decimal(6, 2)
  restSeconds Int?            @map("rest_seconds")
  notes       String?
  createdAt   DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)

  exercise    WorkoutExercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@unique([exerciseId, setNumber])
  @@index([exerciseId])
  @@map("workout_sets")
}

model MangaEntry {
  id            String    @id @default(uuid()) @db.Uuid
  userId        String    @map("user_id") @db.Uuid
  title         String
  author        String?
  totalVolumes  Int?      @map("total_volumes")
  ownedVolumes  Int[]     @map("owned_volumes")
  status        String    @default("collecting")
  score         Int?
  notes         String?
  coverUrl      String?   @map("cover_url")
  pricePerVolume Decimal? @map("price_per_volume") @db.Decimal(10, 2)
  totalCost     Decimal?  @default(0) @map("total_cost") @db.Decimal(10, 2)
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user          Profile   @relation(fields: [userId], references: [id], onDelete: Cascade)
  favoriteProfiles Profile[] @relation("FavoriteManga")

  @@index([userId])
  @@index([userId, status])
  @@map("manga_collection")
}

model AnimeEntry {
  id            String    @id @default(uuid()) @db.Uuid
  userId        String    @map("user_id") @db.Uuid
  title         String
  status        String
  currentEpisode Int      @default(0) @map("current_episode")
  totalEpisodes Int?      @map("total_episodes")
  score         Int?
  notes         String?
  coverUrl      String?   @map("cover_url")
  startDate     DateTime? @map("start_date") @db.Date
  endDate       DateTime? @map("end_date") @db.Date
  rewatchCount  Int       @default(0) @map("rewatch_count")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user          Profile   @relation(fields: [userId], references: [id], onDelete: Cascade)
  favoriteProfiles Profile[] @relation("FavoriteAnime")

  @@index([userId])
  @@index([userId, status])
  @@map("anime_list")
}

model Quest {
  id                  String            @id @default(uuid()) @db.Uuid
  userId              String            @map("user_id") @db.Uuid
  title               String
  description         String?
  difficulty          String
  expReward           Int               @map("exp_reward")
  isRecurring         Boolean           @default(false) @map("is_recurring")
  recurrencePattern   String?           @map("recurrence_pattern")
  active              Boolean           @default(true)
  dueDate             DateTime?         @map("due_date") @db.Date
  dueTime             String?           @map("due_time")
  reminderMinutesBefore Int?            @map("reminder_minutes_before") @default(15)
  createdAt           DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user                Profile           @relation(fields: [userId], references: [id], onDelete: Cascade)
  completions         QuestCompletion[]
  notifications       QuestNotification[]

  @@index([userId])
  @@index([userId, active])
  @@map("quests")
}

model QuestCompletion {
  id          String   @id @default(uuid()) @db.Uuid
  questId     String   @map("quest_id") @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  completedAt DateTime @default(now()) @map("completed_at") @db.Timestamptz(6)
  expEarned   Int      @map("exp_earned")
  streakCount Int      @default(1) @map("streak_count")

  quest       Quest    @relation(fields: [questId], references: [id], onDelete: Cascade)
  user        Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([questId])
  @@index([userId, completedAt(sort: Desc)])
  @@map("quest_completions")
}

model QuestNotification {
  id                String   @id @default(uuid()) @db.Uuid
  questId           String   @map("quest_id") @db.Uuid
  userId            String   @map("user_id") @db.Uuid
  notificationType  String   @map("notification_type")
  message           String
  sentAt            DateTime @default(now()) @map("sent_at") @db.Timestamptz(6)
  readAt            DateTime? @map("read_at") @db.Timestamptz(6)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  quest             Quest    @relation(fields: [questId], references: [id], onDelete: Cascade)
  user              Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("quest_notifications")
}

model Party {
  id          String        @id @default(uuid()) @db.Uuid
  name        String
  description String?
  inviteCode  String?       @unique @map("invite_code")
  ownerId     String        @map("owner_id") @db.Uuid
  maxMembers  Int           @default(10) @map("max_members")
  createdAt   DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  owner       Profile       @relation("PartyOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members     PartyMember[]
  sharedLists PartySharedList[]

  @@index([ownerId])
  @@index([inviteCode])
  @@map("parties")
}

model PartyMember {
  id        String   @id @default(uuid()) @db.Uuid
  partyId   String   @map("party_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  role      String   @default("member")
  joinedAt  DateTime @default(now()) @map("joined_at") @db.Timestamptz(6)

  party     Party    @relation(fields: [partyId], references: [id], onDelete: Cascade)
  user      Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([partyId, userId])
  @@index([partyId])
  @@index([userId])
  @@map("party_members")
}

model PartySharedList {
  id        String   @id @default(uuid()) @db.Uuid
  partyId   String   @map("party_id") @db.Uuid
  name      String
  listType  String   @map("list_type")
  createdBy String   @map("created_by") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  party     Party    @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@index([partyId])
  @@map("party_shared_lists")
}

model ReleaseCalendar {
  id          String    @id @default(uuid()) @db.Uuid
  userId      String?   @map("user_id") @db.Uuid
  title       String
  releaseType String    @map("release_type")
  releaseDate DateTime  @map("release_date") @db.Date
  description String?
  url         String?
  isGlobal    Boolean   @default(false) @map("is_global")
  notified    Boolean   @default(false)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  user        Profile?  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([releaseDate])
  @@index([userId])
  @@index([isGlobal])
  @@map("release_calendar")
}

